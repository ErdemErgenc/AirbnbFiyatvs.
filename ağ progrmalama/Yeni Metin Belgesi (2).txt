import pandas as pd
import streamlit as st
from streamlit_folium import folium_static
import folium
import matplotlib.pyplot as plt
from matplotlib.cm import ScalarMappable
import matplotlib.cm as cm
import seaborn as sns
import networkx as nx
import plotly.express as px
import plotly.graph_objects as go
from bokeh.models import HoverTool
from bokeh.palettes import Category10
from bokeh.plotting import figure
from bokeh.models import ColumnDataSource
import time
import scipy as sp
from pyvis.network import Network









# Verileri Yükleme
data = pd.read_csv("C:/Users/MONSTER/Downloads/listings.csv", nrows=500)

# Fiyat Aralığı Seçimi
min_price = st.sidebar.number_input("Minimum Fiyat", min_value=0, max_value=int(max(data["price"])), value=0)
max_price = st.sidebar.number_input("Maksimum Fiyat", min_value=int(min(data["price"])), max_value=int(max(data["price"])), value=int(max(data["price"])))

# Fiyat Aralığına Göre Veriyi Filtreleme
data_filtered = data[(data["price"] >= min_price) & (data["price"] <= max_price)]

# Grafiklerin Adları
graph_names = [
    "Oda Tipine Göre Dağılım",
    "Ev Sahibinin İnceleme Puanı ve Minimum Gece Sayısı İlişkisi",
    "Konuma Göre Ortalama Fiyat ve Minimum Gece Sayısı",
    "Fiyat ve İnceleme Puanı İlişkisi",
    "Bölgeye Göre Oda Sayısı ve Doluluk Durumu"
]

# Butonlar için döngü oluşturma
selected_graph = None
for graph_name in graph_names:
    if st.button(graph_name, key=f"{graph_name}_button"):
        selected_graph = graph_name

# Seçilen grafikleri gösterme
if selected_graph == "Oda Tipine Göre Dağılım":
    st.subheader("Oda Tipine Göre Dağılım")
    room_type_counts = data_filtered["room_type"].value_counts()
    fig, ax = plt.subplots()
    room_type_counts.plot(kind="pie", autopct='%1.1f%%', ax=ax)
    ax.set_ylabel("")  # Y ekseni etiketini kaldırma
    ax.set_title("Oda Tipine Göre Dağılım")
    st.pyplot(fig)

elif selected_graph == "Ev Sahibinin İnceleme Puanı ve Minimum Gece Sayısı İlişkisi":
    st.subheader("Ev Sahibinin İnceleme Puanı ve Minimum Gece Sayısı İlişkisi")
    fig, ax = plt.subplots()
    ax.scatter(data_filtered["reviews_per_month"], data_filtered["minimum_nights"], alpha=0.5)
    ax.set_xlabel("İnceleme Puanı")
    ax.set_ylabel("Minimum Gece Sayısı")
    ax.set_title("Ev Sahibinin İnceleme Puanı ve Minimum Gece Sayısı İlişkisi")
    st.pyplot(fig)

elif selected_graph == "Konuma Göre Ortalama Fiyat ve Minimum Gece Sayısı":
    st.subheader("Konuma Göre Ortalama Fiyat ve Minimum Gece Sayısı")
    avg_price_min_nights = data_filtered.groupby("neighbourhood")[["price", "minimum_nights"]].mean()
    fig, ax = plt.subplots()
    avg_price_min_nights.plot(kind="bar", alpha=0.75, ax=ax)
    ax.set_xlabel("Konum")
    ax.set_ylabel("Ortalama Fiyat / Minimum Gece Sayısı")
    ax.set_title("Konuma Göre Ortalama Fiyat ve Minimum Gece Sayısı")
    st.pyplot(fig)

elif selected_graph == "Fiyat ve İnceleme Puanı İlişkisi":
    st.subheader("Fiyat ve İnceleme Puanı İlişkisi")
    fig, ax = plt.subplots()
    ax.scatter(data_filtered["price"], data_filtered["reviews_per_month"], alpha=0.5)
    ax.set_xlabel("Fiyat")
    ax.set_ylabel("İnceleme Puanı")
    ax.set_title("Fiyat ve İnceleme Puanı İlişkisi")
    st.pyplot(fig)

elif selected_graph == "Bölgeye Göre Oda Sayısı ve Doluluk Durumu":
    st.subheader("Bölgeye Göre Oda Sayısı ve Doluluk Durumu")
    room_counts = data_filtered["neighbourhood"].value_counts()
    fig, ax = plt.subplots()
    room_counts.plot(kind="bar", alpha=0.75, ax=ax)
    ax.set_xlabel("Konum")
    ax.set_ylabel("Oda Sayısı")
    ax.set_title("Bölgeye Göre Oda Sayısı ve Doluluk Durumu")
    st.pyplot(fig)

# Harita oluşturma ve konumları işaret etme
st.subheader("Tüm Konumların Gösterildiği Harita")
m = folium.Map(location=[data_filtered["latitude"].mean(), data_filtered["longitude"].mean()], zoom_start=12)
for index, row in data_filtered.iterrows():
    folium.Marker([row["latitude"], row["longitude"]], popup=row["neighbourhood"]).add_to(m)

# Folium haritasını Streamlit'e gömmek için folium_static kullanılıyor
folium_static(m)














# Verileri Yükleme ve İlk 20 Satırı Seçme
data_filtered = pd.read_csv("C:/Users/MONSTER/Downloads/listings.csv").head(20)

# Konum ve fiyat temelli gruplama
grouped_data = data_filtered.groupby(["neighbourhood", "price"])

# Ortalama fiyat ve ilan sayısını hesaplama
average_prices = grouped_data["price"].mean().reset_index(name="average_price")
average_prices["listing_count"] = grouped_data["id"].size().reset_index(name="count")["count"].to_list()

# En iyi puanlı konaklamaları seçme
best_listings = data_filtered.groupby('neighbourhood').apply(lambda x: x.nlargest(1, 'number_of_reviews')).reset_index(drop=True)

# Ağ oluşturma
G = nx.Graph()

for index, row in average_prices.iterrows():
    node_id = f"{row['neighbourhood']}_{row['average_price']}"
    G.add_node(node_id, price=row["average_price"], listing_count=row["listing_count"])

for _, row in best_listings.iterrows():
    G.add_node(row['neighbourhood'], best_listing=row['name'], review_score=row['number_of_reviews'])

for i, node1 in average_prices.iterrows():
    for j, node2 in average_prices.iterrows():
        if i != j and node1["neighbourhood"] == node2["neighbourhood"]:
            price_diff = abs(node1["average_price"] - node2["average_price"])
            if price_diff <= 100:
                weight = 3
            elif price_diff <= 200:
                weight = 2
            else:
                weight = 1
            G.add_edge(f"{node1['neighbourhood']}_{node1['average_price']}",
                       f"{node2['neighbourhood']}_{node2['average_price']}",
                       weight=weight)

# Görselleştirme
nt = Network(height="800px", width="100%", bgcolor="#222222", font_color="white")

# Düğümleri ekleme
for node in G.nodes():
    if 'best_listing' in G.nodes[node]:
        nt.add_node(node, label=node, title=f"En İyi İlan: {G.nodes[node]['best_listing']}\nİnceleme Puanı: {G.nodes[node]['review_score']}", size=50)
    else:
        nt.add_node(node, label=node, title=f"Ortalama Fiyat: {G.nodes[node]['price']}\nİlan Sayısı: {G.nodes[node]['listing_count']}", size=30)

# Kenarları ekleyin
for edge in G.edges():
    nt.add_edge(edge[0], edge[1], title=f"Fiyat Farkı: {abs(G.nodes[edge[0]]['price'] - G.nodes[edge[1]]['price'])}")

# HTML dosyasını oluşturun
nt.write_html("airbnb_network.html")

# HTML dosyasının içeriğini gösterin
st.title("Airbnb İlanlarının Fiyat ve Bağlantı Grafiği")
st.write("Bu görselleştirme, Airbnb ilanlarının konumlarına ve fiyatlarına göre oluşturulmuş bir ağ grafiğidir.")
st.write("Düğümlere ve çizgilere tıkladığınızda daha fazla bilgi alabilirsiniz.")
st.components.v1.html(open("airbnb_network.html", "r").read(), height=900)













# Görsel Kodlama
if st.button("Görsel Kodlama Yap"):
    st.subheader("Görsel Kodlama")
    # Veriyi görselleştirme
    fig = px.scatter(data_filtered, x="price", y="number_of_reviews")
    st.plotly_chart(fig)   

# En İyi Konaklama Yerlerini Sıralama
if st.button("Sırala"):
    st.subheader("En İyi Konaklama Yerleri")
    top_listings = data_filtered.sort_values(by=["price", "reviews_per_month"], ascending=[True, False]).head(10)
    
    # Tabloyu oluşturma
    fig = go.Figure(data=[go.Table(
        header=dict(values=["İsim", "İnceleme Puanı", "Konum", "Fiyat"],
                    fill_color='paleturquoise',
                    align='left'),
        cells=dict(values=[top_listings["name"], 
                           top_listings["reviews_per_month"], 
                           top_listings["neighbourhood"], 
                           top_listings["price"]],
                   fill_color='lavender',
                   align='left'))
    ])
    
    # Tabloyu gösterme
    st.plotly_chart(fig)












# Verileri Yükleme


# Fiyat Aralığı Seçimi
# min_price = st.sidebar.number_input("Minimum Fiyat", min_value=0, max_value=int(max(data["price"])), value=0, key="min_price_input")
# max_price = st.sidebar.number_input("Maksimum Fiyat", min_value=int(min(data["price"])), max_value=int(max(data["price"])), value=int(max(data["price"])), key="max_price_input")


# Fiyat Aralığına Göre Veriyi Filtreleme
data_filtered = data[(data["price"] >= min_price) & (data["price"] <= max_price)]

# İlçelere Göre Ortalama Fiyatları Hesaplama
avg_prices_by_neighbourhood = data_filtered.groupby("neighbourhood")["price"].mean().reset_index()

# İlçelere Göre Ortalama Fiyatları Görselleştirme
fig = px.bar(avg_prices_by_neighbourhood, x="neighbourhood", y="price", title="İstanbul İlçelerine Göre Ortalama Fiyatlar")
fig.update_xaxes(title="İlçe")
fig.update_yaxes(title="Ortalama Fiyat")
st.plotly_chart(fig)




# Verileri Yükleme


# Fiyat Aralığı Seçimi için Benzersiz Anahtar Oluşturma
min_price_key = f"min_price_input_{int(time.time())}"
max_price_key = f"max_price_input_{int(time.time())}"

# Fiyat Aralığı Seçimi
min_price = st.sidebar.number_input("Minimum Fiyat", min_value=0, max_value=int(max(data["price"])), value=0, key=min_price_key)
max_price = st.sidebar.number_input("Maksimum Fiyat", min_value=int(min(data["price"])), max_value=int(max(data["price"])), value=int(max(data["price"])), key=max_price_key)

# Fiyat Aralığına Göre Veriyi Filtreleme
data_filtered = data[(data["price"] >= min_price) & (data["price"] <= max_price)]

# İlçelere Göre Ortalama Fiyatları Hesaplama
avg_prices_by_neighbourhood = data_filtered.groupby("neighbourhood")["price"].mean().reset_index()

# Renk Paleti ve Fiyat Aralıkları Belirleme
price_ranges = [210.48, 263.25, 344.80, 420.63, 481.46, 542.43, 664.86, 802.76, 912.69, 1028.05, 1574.78]
colors = ["#f7fbff", "#ebf3fa", "#dee7f5", "#cedbf1", "#adb5ed", "#8799d8", "#6a7eb3", "#54679f", "#3e508b", "#293c77"]











# Görselleştirme Oluşturma
def visualize_istanbul_districts():

     # İstanbul ilçeleri listesi
    istanbul_districts = ["Kadıköy", "Beşiktaş", "Şişli", "Beyoğlu", "Fatih", "Üsküdar", "Sarıyer", "Bakırköy", "Kartal", "Maltepe", "Ataşehir", "Pendik", "Beylikdüzü", "Ümraniye", "Eyüpsultan", "Avcılar", "Bağcılar", "Bahçelievler", "Gaziosmanpaşa", "Başakşehir", "Esenler", "Silivri", "Kağıthane", "Sultangazi", "Büyükçekmece", "Sancaktepe", "Esenyurt", "Bayrampaşa", "Zeytinburnu", "Tuzla", "Şile", "Arnavutköy", "Çekmeköy", "Küçükçekmece", "Çatalca", "Sultangazi"]

    # İstanbul ilçelerine göre filtreleme
    istanbul_district_data = data[data["neighbourhood"].isin(istanbul_districts)]

    # Fiyat aralıkları için renk paleti oluşturma
    price_ranges = list(range(0, 10500, 500))
    colors = px.colors.diverging.RdBu[:len(price_ranges)]

    # İstanbul haritasını gösterme
    fig = px.scatter_mapbox(istanbul_district_data, 
                             lat="latitude", 
                             lon="longitude", 
                             color="price", 
                             hover_name="neighbourhood",
                             hover_data=["price"],
                             zoom=10,
                             color_continuous_scale=colors)
    fig.update_layout(mapbox_style="open-street-map")
    st.plotly_chart(fig)

if __name__ == "__main__":
    visualize_istanbul_districts()










